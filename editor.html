<html>
<head>
<link href='http://fonts.googleapis.com/css?family=Permanent+Marker' rel='stylesheet' type='text/css'>
<link type="text/css" href="css/bandit.css" rel="stylesheet"/>
<script src="js/jquery-1.7.2.min.js" type="text/javascript"></script>
<script src="js/jquery.base64.min.js" type="text/javascript"></script>
<script src="js/raphael-min.js" type="text/javascript"></script>
<script src="js/bandit.js" type="text/javascript"></script>

<script>
$(document).ready(function(){
});
</script>
<title>ManBand</title>
</head>
<body>
<script>
$(document).ready(function() {

banditLogger = new BanditLogger(0);

bandit = new BandIt("myeditor",1200,800);

bandit.registerSelect(function(nodeid,properties) {
        var props = '<div id="bandnode"><h2>'+nodeid+' - '+properties["name"]+'</h2>';
        props += '<input type="hidden" id="bandnodeid" name="bandnodeid" value="'+nodeid+'"/>';
        for (var i in properties)
        {
                props += '<div><label for="'+i+'">'+i+'</label>';
                props += '<input type="text" id="'+i+'" name="'+i+'" value=""/></div>';
        }
        props += '<input type="submit" id="bandnodeupdate" value="update"/></div>';

        $("#node").html(props);
        for(var i in properties)
        {
          $("#"+i).val(properties[i]);
        }
        list = [ "fill", "stroke", "width", "height" ];
        objattr = bandit.getPaper().getById(nodeid).attr();
        var props = '<div id="bandnodeattr"><h2>Attributes</h2>';
        props += '<input type="hidden" id="bandnodeid" name="bandnodeid" value="'+nodeid+'"/>';
        for (var i in objattr)
        {
             if(jQuery.inArray(i,list)>-1) {
                props += '<div><label for="'+i+'">'+i+'</label>';
                props += '<input type="text" id="'+i+'" name="'+i+'" value=""/></div>';
             }
        }
        props += '<input type="submit" id="bandnodeattrupdate" value="update"/></div>';

        $("#nodeattrs").html(props);
        for(var i in objattr)
        {
          if(jQuery.inArray(i,list)>-1) {
            $("#"+i).val(objattr[i]);
           }
        }

});


props = {};
props["command"] = "" ;
props["store"] = "false" ;
props["queue"] = "" ;
props["description"] = "" ;
bandit.setDefaultProperties(props);

bandit.add("root", { fill: "#6E6E6E" });

updatemode(0);

$('#move').click(function() {
  updatemode(0);
});

$('#add').click(function() {
    updatemode(0);
    bandit.add();
});

$('#left').click(function() {
  bandit.moveLeft(10);
});

$('#right').click(function() {
  bandit.moveRight(10);
});
  
$('#up').click(function() {
  bandit.moveUp(10);
});

$('#down').click(function() {
  bandit.moveDown(10);
});



$('#zoomin').click(function() {
  bandit.zoomIn();
});

$('#zoomout').click(function() {
  bandit.zoomOut();
});

$('#link').click(function() {
    updatemode(1);
});

$('#save').click(function() {
  var save = $.base64.encode(bandit.export());
  var recipe =  window.open('','MyWorkflow','width=600,height=400');
    var html = '<html><head><title>MyWorkflow</title></head><body><div style="width:600px;">' + save + '</div></body></html>';
    recipe.document.open();
    recipe.document.write(html);
    recipe.document.close();
});

$('#clean').click(function() {
    bandit.clean();
    bandit.add("root", { fill: "#6E6E6E" });
});

$('#delete').click(function() {
    updatemode(2);
});

$('#group').click(function() {
    updatemode(3);
});

$('#wname').change(function() {
   bandit.info($('#wname').val(),$('#wdesc').val());
});

$('#wdesc').change(function() {
   bandit.info($('#wname').val(),$('#wdesc').val());
});

// Make sure only 1 button is active (exclusive)
function updatemode(newmode) {
  if(newmode==0) {
    $('#link').css('border-style','outset');
    $('#delete').css('border-style','outset');
    $('#move').css('border-style','inset');
    $('#group').css('border-style','outset');
  }
  else if(newmode==1) {
    $('#link').css('border-style','inset');
    $('#delete').css('border-style','outset');
    $('#move').css('border-style','outset');
    $('#group').css('border-style','outset');
  }
  else if(newmode==2) {
    $('#link').css('border-style','outset');
    $('#delete').css('border-style','inset');
    $('#move').css('border-style','outset');
    $('#group').css('border-style','outset');
  }
  else if(newmode==3) {
    $('#link').css('border-style','outset');
    $('#delete').css('border-style','outset');
    $('#move').css('border-style','outset');
    $('#group').css('border-style','inset');
  }
  bandit.setMode(newmode);
}

});

//  Get props on select callback, display them and update
$(document).ready(function() {
$("#bandnodeupdate").live("click", function(){
   newprops = {};
   var elts = $('#bandnode').find('input');
   var id="";
    elts.each(function() {
     if($(this).attr("id")!="bandnodeupdate" && $(this).attr("id")!="bandnodeid") {
       newprops[$(this).attr("id")] = $(this).val();
     }
     if($(this).attr("id")=="bandnodeid") {
       id = $(this).val();
     }
   });
   bandit.setProperties(id,newprops);
});

$("#bandnodeattrupdate").live("click", function(){
   newprops = {};
   var elts = $('#bandnodeattr').find('input');
   var id="";
    elts.each(function() {
     if($(this).attr("id")!="bandnodeupdate" && $(this).attr("id")!="bandnodeid") {
       newprops[$(this).attr("id")] = $(this).val();
     }
     if($(this).attr("id")=="bandnodeid") {
       id = $(this).val();
     }
   });
   bandit.setAttributes(id,newprops);
});




// Workflow load management

var holder = document.getElementById('holder');
var infos = document.getElementById('info');
 
holder.ondragover = function () {
  this.className = 'hover';
  return false;
};
 
holder.ondragend = function () {
  this.className = '';
  return false;
};

holder.ondrop = function (e) {
  this.className = '';
  e.preventDefault();
 
  var file = e.dataTransfer.files[0];
  var reader = new FileReader();

  reader.onload = (function(theFile) {
        return function(e) {
          var desc = bandit.load(e.target.result,true);
          $('#wname').val(desc[0]);
          $('#wdesc').val(desc[1]);
        };
      })(file);
  reader.readAsText(file);
 
  var info = document.createElement("span");
  info.innerHTML = file.name + ": " + file.size + " bytes ";
  $('#holder').html(info);
  return false;
};


});



</script>
<div class="header">
<h1><img id="logo" src="images/bandit.png"/>BandIt editor</h1>
</div>
<div id="holder"><p>Drop a workflow here to load it!</p></div>
<div id="info">
<label for="wname">Name</label>
<input type="text" id="wname" value="sample"/>
<label for="wdesc">Description</label>
<textarea rows="3" cols="80" id="wdesc" value=""></textarea>
</div>
<div class="tools">
<div class="tool" id="add"><img title="add node" alt="add node" src="images/add.png"/></div>
<div class="tool" id="move"><img title="move selection" alt="move selection" src="images/move.png"/></div>
<div class="tool" id="group"><img title="group selection" alt="group selection" src="images/group.png"/></div>
<div class="tool" id="link"><img title="create link" alt="create link" src="images/link.png"/></div>
<div class="tool" id="delete"><img title="delete" alt="delete" src="images/delete.png"/></div>
<div class="tool" id="save"><img title="save" alt="save" src="images/save.png"/></div>
<div class="tool" id="clean"><img title="clean worflow" alt="clean worflow" src="images/clean.png"/></div>
<div class="tool" style="width:100px;"></div>
<div class="tool" id="zoomin"><img title="zoom in" alt="zoom in" src="images/zoomin.png"/></div>
<div class="tool" id="zoomout"><img title="zoom out" alt="zoom out" src="images/zoomout.png"/></div>
<div class="tool" id="left"><img title="move left" alt="move left" src="images/left.png"/></div>
<div class="tool" id="right"><img title="move right" alt="move right" src="images/right.png"/></div>
<div class="tool" id="up"><img title="move up" alt="move up" src="images/up.png"/></div>
<div class="tool" id="down"><img title="move down" alt="move down" src="images/down.png"/></div>
</div>
<div class="editor" id="myeditor"></div>
<div id="node"></div>
<div id="nodeattrs"></div>
</body>
</html>
